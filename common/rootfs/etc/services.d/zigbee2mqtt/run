#!/usr/bin/with-contenv bashio

if bashio::config.true 'zigbee_herdsman_debug'; then
    bashio::log.info "Zigbee Herdsman debug logging enabled"
    export DEBUG="zigbee-herdsman:*"
fi
export NODE_PATH=/app/node_modules
export ZIGBEE2MQTT_DATA="$(bashio::config 'data_path')"
export ZIGBEE2MQTT_CONFIG_FRONTEND_PORT=8099
export ZIGBEE2MQTT_CONFIG_HOMEASSISTANT=true

if bashio::var.has_value "$(bashio::services 'mqtt')"; then
    if [ $(bashio::services 'mqtt' 'ssl') = true ]; then
        export ZIGBEE2MQTT_CONFIG_MQTT_SERVER="mqtts://$(bashio::services 'mqtt' 'host'):$(bashio::services 'mqtt' 'port')"
    else
        export ZIGBEE2MQTT_CONFIG_MQTT_SERVER="mqtt://$(bashio::services 'mqtt' 'host'):$(bashio::services 'mqtt' 'port')"
    fi
    export ZIGBEE2MQTT_CONFIG_MQTT_USER="$(bashio::services 'mqtt' 'username')"
    export ZIGBEE2MQTT_CONFIG_MQTT_PASSWORD="$(bashio::services 'mqtt' 'password')"
fi

cd /app || bashio::exit.nok "Could not change directory to /app"
bashio::log.info "Handing over control to Zigbee2mqtt Core ..."
exec npm start
